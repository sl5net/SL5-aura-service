#!/bin/bash
# .git/hooks/pre-commit



# --- Start of flake8 check ---
echo "Running flake8 code quality check..."

# Activate virtual environment if it exists
if [ -f .venv/bin/activate ]; then
  source .venv/bin/activate
fi

# Run flake8 on specific directories
flake8 ./dictation_service.py ./scripts ./config
# flake8 ./scripts ./config/languagetool_server/maps

# Abort commit if flake8 finds errors
if [ $? -ne 0 ]; then
  echo "COMMIT REJECTED: flake8 found issues."
  exit 1
fi

echo "flake8 check passed."
# --- End of flake8 check ---





# Check if pipreqs is available in the venv
if [ ! -x ".venv/bin/pipreqs" ]; then
    echo "pipreqs is not installed in .venv. Please run '.venv/bin/pip install pipreqs' inside your virtual environment."
    exit 1
fi

TMPDIR=".pipreqs_temp"

# Clean up and create a fresh temp directory
rm -rf "$TMPDIR"
mkdir "$TMPDIR"

# Copy all relevant Python sources into the temp directory
cp dictation_service.py "$TMPDIR/"
cp get_suggestions.py "$TMPDIR/"
# Das gesamte 'scripts'-Verzeichnis kopieren, damit Import-Pfade erhalten bleiben.
cp -r scripts "$TMPDIR/"


echo "INFO: Generating requirements.txt (take into account .pipreqs-whitelist.txt) ..."

# --- FINALE KORREKTUR HIER: ---
# Wir benutzen --savepath, um pipreqs anzuweisen, die Datei im aktuellen
# Verzeichnis zu speichern, während es das Temp-Verzeichnis analysiert.
# Die Warnungen fangen wir weiterhin für die Whitelist ab.
WARNINGS=$(.venv/bin/pipreqs "$TMPDIR" --savepath ./requirements.txt --force --encoding=utf-8 2>&1 >/dev/null)


# Filtere die Warnungen. Zeige nur die an, die NICHT in der Whitelist stehen.
if [ -s ".pipreqs-whitelist.txt" ]; then
    # Zeige nur die Zeilen, die nicht in der Whitelist sind
    echo "$WARNINGS" | grep -v -f .pipreqs-whitelist.txt | grep -v "Please, verify manually"
else
    # Wenn die Whitelist leer ist, zeige alle Warnungen
    echo "$WARNINGS"
fi

# Remove known false positives like our own 'scripts' directory
sed -i '/^scripts==/d' requirements.txt

# Convert package names to lowercase
awk -F'==' '/==/ {print tolower($1) "==" $2}' requirements.txt > requirements.txt.tmp && mv requirements.txt.tmp requirements.txt

# Clean up temp directory
rm -rf "$TMPDIR"

# add some explizit that e.g. used in little config/maps/plugin scripts
echo "wikipedia-api" >> requirements.txt
echo "bs4" >> requirements.txt

cp .git/hooks/pre-commit docs/pre-commit_backup.txt

#
