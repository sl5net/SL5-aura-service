#!/bin/bash
# .git/hooks/pre-commit

# -----------------------------------------------------------------------------
# 1. QUALITY CHECK (Flake8)
# -----------------------------------------------------------------------------
echo "Running flake8 code quality check..."

# Activate virtual environment if it exists
if [ -f .venv/bin/activate ]; then
  source .venv/bin/activate
fi

# Run flake8 on specific directories
flake8 ./aura_engine.py ./scripts ./config

# Abort commit if flake8 finds errors
if [ $? -ne 0 ]; then
  echo "COMMIT REJECTED: flake8 found issues."
  exit 1
fi

echo "flake8 check passed."

# -----------------------------------------------------------------------------
# 2. SETUP FOR REQUIREMENTS GENERATION
# -----------------------------------------------------------------------------

# Check if pipreqs is available in the venv
if [ ! -x ".venv/bin/pipreqs" ]; then
    echo "pipreqs is not installed in .venv. Please run '.venv/bin/pip install pipreqs' inside your virtual environment."
    exit 1
fi

TMPDIR=".pipreqs_temp"

# Clean up and create a fresh temp directory
rm -rf "$TMPDIR"
mkdir "$TMPDIR"

# Copy all relevant Python sources into the temp directory
cp aura_engine.py "$TMPDIR/"
cp get_suggestions.py "$TMPDIR/"
# Copy the entire 'scripts' directory to preserve import paths
cp -r scripts "$TMPDIR/"


echo "INFO: Generating requirements.txt (taking into account .pipreqs-whitelist.txt) ..."

# -----------------------------------------------------------------------------
# 3. GENERATE BASE REQUIREMENTS
# -----------------------------------------------------------------------------
# We use --savepath to tell pipreqs to save the file in the current
# directory while analyzing the temp directory.
WARNINGS=$(.venv/bin/pipreqs "$TMPDIR" --savepath ./requirements.txt --force --encoding=utf-8 2>&1 >/dev/null)

# Filter warnings. Only show those NOT in the whitelist.
if [ -s ".pipreqs-whitelist.txt" ]; then
    echo "$WARNINGS" | grep -v -f .pipreqs-whitelist.txt | grep -v "Please, verify manually"
else
    echo "$WARNINGS"
fi

# -----------------------------------------------------------------------------
# 4. PATCHING & CLEANUP (The "Patching Strategy")
# -----------------------------------------------------------------------------

# A) General Cleanup
# Remove known false positives like our own 'scripts' directory
sed -i '/^scripts==/d' requirements.txt

# Convert package names to lowercase to avoid duplicates like "Psutil" vs "psutil"
awk -F'==' '/==/ {print tolower($1) "==" $2}' requirements.txt > requirements.txt.tmp && mv requirements.txt.tmp requirements.txt

# B) RELAXATION FIX (Fix for psutil, requests, etc.)
# We remove the strict entries generated by pipreqs and add relaxed versions (>=)
# to prevent conflicts (e.g. 7.1.3 vs 7.0.0).
sed -i '/^psutil/d' requirements.txt
sed -i '/^requests/d' requirements.txt
sed -i '/^tqdm/d' requirements.txt
sed -i '/^colorama/d' requirements.txt

# Re-add them with loose versioning
echo "psutil>=7.0.0" >> requirements.txt
echo "requests>=2.28.0" >> requirements.txt
echo "tqdm>=4.60.0" >> requirements.txt
echo "colorama>=0.4.0" >> requirements.txt

# C) PLATFORM-SPECIFIC FIXES

# Fix Fasttext: Remove generic, add platform specific
echo "INFO: Applying Fasttext platform-specific fix..."
sed -i '/^fasttext==/d' requirements.txt
echo "fasttext==0.9.3; sys_platform != 'win32'" >> requirements.txt
echo "fasttext-wheel==0.9.2; sys_platform == 'win32'" >> requirements.txt

# Fix Windows Audio & Control (remove generic, add win32 only)
sed -i '/^comtypes/d' requirements.txt
sed -i '/^pycaw/d' requirements.txt
echo "comtypes==1.4.11; sys_platform == 'win32'" >> requirements.txt
echo "pycaw==20240210; sys_platform == 'win32'" >> requirements.txt

# D) EXPLICIT EXTRAS
# Add packages that might be missed by static analysis
echo "wikipedia-api" >> requirements.txt
echo "bs4" >> requirements.txt

echo "pyperclip" >> requirements.txt
echo "cologne_phonetics" >> requirements.txt
echo "jellyfish" >> requirements.txt

# -----------------------------------------------------------------------------
# 5. CLEANUP
# -----------------------------------------------------------------------------
rm -rf "$TMPDIR"

# Backup the hook for reference
cp .git/hooks/pre-commit docs/pre-commit_backup.txt
